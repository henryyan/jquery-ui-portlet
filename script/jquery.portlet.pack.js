(function(a,b){a.widget("ui.portlet",{options:{columns:[],sortable:true,singleView:true,removeItem:null,filterRepeat:false,columnWidth:300,events:{drag:{start:null,stop:null,over:null}}},_create:function(){this.element.addClass("ui-portlet");var e=this;var c=e.element;var d=e.options;if(!d.columns||d.columns.length==0){a("<div/>",{width:d.columnWidth}).addClass("ui-portlet-column").appendTo(c)}a.each(d.columns,function(f,h){var g=a("<div/>",{width:h.width}).addClass("ui-portlet-column").appendTo(c);a.each(h.portlets,function(i,j){e._createSinglePortlet(e,c,g,"last",j)})});e._initEvents();if(d.singleView===true){e._regSingleView()}e._sortable(d.sortable)},_createSinglePortlet:function(k,f,h,d,g){var e=k.options;if(e.filterRepeat===true){if(g.attrs.id){if(a("#"+g.attrs.id).length>0){if(a.isFunction(e.handleRepeat)){var c=e.handleRepeat.call(f,h,g);if(c===false){return}}else{return}}}}if(a.isFunction(g.beforeCreate)){var c=g.beforeCreate.call(f,d);if(!c){return}}var l=a("<div/>").addClass("ui-portlet-item ui-widget ui-widget-content ui-helper-clearfix ui-corner-all").data("option",g);if(d==="last"){l.appendTo(h)}else{if(d.x==="last"){l.insertAfter(a(h).find(".ui-portlet-item:last"))}else{l.insertBefore(a(h).find(".ui-portlet-item").eq(d.x))}}if(g.attrs){l.attr(g.attrs)}var j=a("<div/>",{"class":"ui-portlet-header ui-widget-header ui-corner-all",html:function(){if(a.isFunction(g.title)){return g.title}if(g.icon){return"<span class='"+g.icon+"'></span>"+g.title}else{return g.title}}}).appendTo(l);if(g.icon){j.prepend("<span class='ui-portlet-header-icon ui-icon "+g.icon+"'></span>")}j.prepend("<a href='#' class='ui-corner-all ui-portlet-event'><span class='ui-icon ui-icon-refresh ui-portlet-refresh'></span></a>");j.prepend("<a href='#' class='ui-corner-all ui-portlet-event'><span class='ui-icon ui-icon-minusthick ui-portlet-toggle'></span></a>");j.prepend("<a href='#' class='ui-corner-all ui-portlet-event'><span class='ui-icon ui-icon-closethick ui-portlet-close'></span></a>");j.prepend("<a href='#' class='ui-corner-all ui-portlet-event'><span class='ui-icon ui-icon-newwin ui-portlet-max'></span></a>");var i=a("<div/>",{"class":"ui-portlet-content"}).appendTo(l);if(g.content.style){a(i).css(g.content.style)}if(g.content.attrs){a.each(g.content.attrs,function(o,n){var m=i.attr(o);if(m){if(o=="style"&&n.substr(n.length-1)!=";"){m+=";"}if(o=="class"){m+=" "}m+=n}i.attr(o,m)})}k._content.call(f,l,g,function(m){k._loadScripts(g.scripts,function(){if(a.isFunction(g.afterLoadContent)){g.afterLoadContent.call(l,l.find(".ui-portlet-content"))}})});if(a.isFunction(g.afterCreated)){g.afterCreated.call(f)}return l},_setOption:function(d,e){var c=this.element;var f=this.options;if(this.options[d]){this.options[d]=e}switch(d){case"sortable":this._sortable(e);break;case"add":this._addSingle(e);break;case"remove":a(e,c).find(".ui-portlet-close").trigger("click");break;case"filterRepeat":if(e==null||e==b){return f.filterRepeat}else{f.filterRepeat=e;break}}},index:function(d,c){var e=this.element;var f={};a(".ui-portlet-column").each(function(h,g){a(".ui-portlet-item",this).each(function(i,k){var l=a(this).attr("id");f[l]={x:h,y:i}})});return f},move:function(j,c,i){var h=this;var e=h.element;var g=this.options;var d;d=a(".ui-portlet-column",e).eq(c);var f=a(d).find(".ui-portlet-item").eq(i);a(j).detach().insertBefore(f)},_regSingleView:function(){var d=this.element;var c=function(){var f=a(this).parents(".ui-portlet-item");var g=f.data("option");f.css({height:"auto"});if(f.hasClass("ui-portlet-single-view")){a(d).find(".ui-portlet-item").show();f.removeClass("ui-portlet-single-view").animate({width:f.data("width")+2,height:g.content.style?g.content.style.height+a(f.children()[0]).outerHeight()+8:"auto"}).css({position:"static"}).removeData("width").removeData("height");if(g.singleView){if(a.isFunction(g.singleView.recovery)){g.singleView.recovery.call(f,g)}}}else{a(d).find(".ui-portlet-item").hide();f.show().addClass("ui-portlet-single-view").data({width:f.width(),height:f.height()}).css({position:"absolute",left:0,top:0});var e={};if(g.singleView){if(g.singleView.width){if(a.isFunction(g.singleView.width)){e.width=g.singleView.width.call(f,g)}else{e.width=g.singleView.width}}else{e.width=a(window).width()*0.85}if(g.singleView.height){if(a.isFunction(g.singleView.height)){e.height=g.singleView.height.call(f,g)}else{e.height=g.singleView.height}}else{e.height=a(window).height()*0.85}}else{e.width=a(window).width()*0.85;e.height=a(window).height()*0.85}f.animate({width:e.width,height:e.height});if(g.singleView&&a.isFunction(g.singleView.enable)){g.singleView.enable.call(f,g)}}};a(d).find(".ui-portlet-header").dblclick(c);a(d).find(".ui-portlet-max").click(c)},_loadScripts:function(c,d){if(c){a.each(c,function(){var e=a("head").remove("#loadScript");a("<script><\/script>").attr({src:this,type:"text/javascript",id:"loadScript"}).appendTo(e)})}if(a.isFunction(d)){d()}},_sortable:function(d){var e=this.options;var c=a(".ui-portlet-column",this.element).sortable({connectWith:".ui-portlet-column",start:function(f,g){if(a.isFunction(e.events.drag.start)){e.events.drag.start.call(g.item[0],f,g)}},stop:function(f,g){if(a.isFunction(e.events.drag.stop)){e.events.drag.stop.call(g.item[0],f,g)}},over:function(f,g){if(a.isFunction(e.events.drag.over)){e.events.drag.over.call(g.item[0],f,g)}}});if(d===true){a(this.element).find(".ui-portlet-header").css("cursor","move");c.sortable("enable");a(".ui-portlet-content",this.element).draggable({start:function(g,f){return false}})}else{a(this.element).find(".ui-portlet-header").css("cursor","default");c.sortable("disable")}},_addSingle:function(d){var i=this;var g=i.element;var h=this.options;var f=d;var c;if(a(".ui-portlet-column",g).eq(f.position.y).length>0){c=a(".ui-portlet-column",g).eq(f.position.y)}else{c=a(".ui-portlet-column",g).eq(0)}console.log(c);var e=i._createSinglePortlet(i,g,c,d.position,d.portlet);i._initEvents(e);if(h.singleView===true){i._regSingleView()}i._sortable(h.sortable)},_initEvents:function(d){var h=this;var f=d||this.element;var c=a(".ui-portlet-toggle",f).click(function(k,j){var i=a(this).parents(".ui-portlet-item:first").find(".ui-portlet-content");j=j||"toggle";if(j=="toggle"){i.slideToggle();a(this).toggleClass("ui-icon-minusthick").toggleClass("ui-icon-plusthick")}else{if(j=="hide"){i.slideUp();a(this).removeClass("ui-icon-minusthick").addClass("ui-icon-plusthick")}else{if(j=="show"){i.slideDown();a(this).removeClass("ui-icon-plusthick").addClass("ui-icon-minusthick")}}}}).dblclick(function(i){i.stopPropagation()});var e=a(".ui-portlet-refresh",f).click(function(i){h.refresh.call(h,i)}).dblclick(function(i){i.stopPropagation()});var g=a(".ui-portlet-close",f).click(function(i){h._destoryItem.call(h,i)}).dblclick(function(i){i.stopPropagation()});this._hoverable(c.parent());this._hoverable(e.parent())},_hoverable:function(c){a(c).hover(function(){a(this).addClass("ui-state-hover")},function(){a(this).removeClass("ui-state-hover")})},_destoryItem:function(e){var f=this.options;var d=a(e.target).parents(".ui-portlet-item");var g=d.data("option");if(a.isFunction(g.beforeRemove)){var c=g.beforeRemove();if(!c){return}}d.remove();if(a.isFunction(f.removeItem)){f.removeItem()}},refresh:function(f){var i=this.options;var h=a(f.target).parents(".ui-portlet");var e=a(f.target).parents(".ui-portlet-item");var c=e.data("option");var d=e.find(".ui-portlet-content");var g=e.parents(".ui-portlet");if(a.isFunction(c.beforeRefresh)){c.beforeRefresh.call(g,c)}this._content.call(h,e,c,function(j){if(a.isFunction(c.afterRefresh)){c.afterRefresh.call(g,j,c)}});this._loadScripts(c.scripts)},_content:function(k,l,j){var c=this.options;var f=this;var h=l.content.type;var g=null;var e=k.find(".ui-portlet-content");if(a.isFunction(l.content.beforeShow)){l.content.beforeShow.call(this,l.content.text)}if(h=="text"){g=l.content.text;if(a.isFunction(g)){g=g(f,k,l)}if(a.isFunction(j)){j.call(f,g)}e.html(g);d(l.content.text)}else{if(h=="ajax"){var i=l.content.dataType||"html";a.ajax({url:l.content.url,dataType:i,beforeSend:function(){a(e).html("Loading...")},success:function(n,o,m){if(i=="html"){g=n;a(e).html(n)}else{if(i=="json"){if(a.isFunction(l.content.formatter)){g=l.content.formatter(c,l,n);a(e).html(g)}}}d(g);if(a.isFunction(j)){j.call(f,n)}},error:function(n,p,o){var m="<span style='padding:0.2em' class='ui-state-error ui-corner-all'>Load Error...</span>";a(e).html(m);if(a.isFunction(l.content.error)){l.content.error.call(e,n,p,o)}}})}}function d(m){if(a.isFunction(l.content.afterShow)){l.content.afterShow.call(f,m)}}},toggle:function(e,d){var c=this.element;a("#"+e+" .ui-portlet-toggle",c).trigger("click",[d||"toggle"])},toggleAll:function(d){var c=this.element;a(".ui-portlet-toggle",c).trigger("click",[d||"toggle"])},destroy:function(){this.element.removeClass("ui-portlet").text("");a.Widget.prototype.destroy.call(this);return this}})})(jQuery);